{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %} Melon POS panel {% endblock %}

{% block content %}

<main class="page-content">
    <div class="d-flex justify-content-between">
        <h4 class="d-inline-flex">Melon Beauty Salon POS system</h4>
        <p id="live-datetime" class="d-inline-flex">Loading...date/time</p>
    </div>
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 row-cols-xxl-4">
        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">Today revenue</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-revenue.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                <hr class="my-2">
                <small class="mb-0"><i class="bi bi-arrow-up"></i> <span>+12.3% from last week</span></small>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">CASH</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-cash.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">PAYNOW</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-paynow.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">Crdit card</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-creditcard.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">Nets</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-nets.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">Grab</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-grab.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">Package</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-package.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">In-store credit</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-instorecredit.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="col">
            <div class="card radius-10">
                <div class="card-body">
                <div class="d-flex align-items-center">
                    <div class="">
                    <p class="mb-1">REFUND</p>
                    <h4 class="mb-0 text-primary">145</h4>
                    </div>
                    <div class="ms-auto fs-2 text-primary">
                        <img src="{% static 'assets/images/icons/pos-refund.png'%}" alt="revenue" class="icon-badge">
                    </div>
                </div>
                </div>
            </div>
        </div>

    </div>
    <hr>
    <div>
        <h5>New transaction</h5>
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {# SaleServices Formset #}
            {{ sale_service_formset.management_form }}
            <div id="services-container" class="border border-success p-2 rounded border-3">
                <span>Services</span>
                <hr>
                {% for service_form in sale_service_formset %}
                    <div class="service-form">
                        <div class="row">
                            <div class="col">
                                <label for="{{service_form.department.label}}" class="form-label">{{service_form.department.label}}</label>
                                {{service_form.department|add_class:"form-control"}}
                            </div>
    
                            <div class="col">
                                <label for="{{service_form.service_name.label}}" class="form-label">{{service_form.service_name.label}}</label>
                                {{service_form.service_name|add_class:"form-control"}}
                            </div>
    
                            <div class="col">
                                <label for="{{service_form.service_price.label}}" class="form-label">{{service_form.service_price.label}}</label>
                                {{service_form.service_price|add_class:"form-control service-price"}}
                            </div>
                        </div>

                        {# Nested ServiceImages Formset #}
                        {{ service_image_formset.management_form }}
                        <div class="images-container">
                            {% for image_form in service_image_formset %}
                                <div class="image-form">
                                    <label for="{{image_form.image.label}}" class="form-label mt-2">{{image_form.image.label}}</label>
                                    {{image_form.image|add_class:"form-control"}}
                                    <button type="button" class="remove-image-btn btn-sm btn-danger m-1">Remove Image</button>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="d-flex flex-row-reverse">
                            <button type="button" class="remove-service-btn btn-sm btn-danger">Remove Service</button>
                            <button type="button" class="add-image-btn btn-sm btn-primary mx-2">Add Image</button>
                        </div>

                        <hr>
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-service-btn" class="btn my-3 btn-info text-light">Add another service</button>
            <button type="button" onclick="calculate_total()" id="calculate_grand_total" class="btn mx-2 btn-info text-light">Calculate grand total</button>
            
            {# SalesTransaction Form #}
            <div>
                <div class="row">
                    <div class="col">
                        <label for="{{form.grand_total.label}}" class="form-label">Grand total:</label>
                        {{ form.grand_total|add_class:"form-control"|append_attr:"disabled"}}
                    </div>
                    <div class="col">
                        <label for="{{form.payment_type.label}}" class="form-label">Payment type:</label>
                        {{ form.payment_type|add_class:"form-control" }}
                    </div>
                </div>

                <label for="{{form.user.label}}" class="form-label">Employee:</label>
                {{form.user|add_class:"form-control"}}

                <div class="row">
                    <div class="col">
                        <label for="{{form.package_history.label}}" class="form-label">{{form.package_history.label}}:</label>
                        {{form.package_history|add_class:"form-control"}}
                    </div>
                    <div class="col">
                        <label for="{{form.credit_history.label}}" class="form-label">{{form.credit_history.label}}:</label>
                        {{form.credit_history|add_class:"form-control"}}
                    </div>
                </div>

                <label for="{{form.personal_remarks.label}}" class="form-label">Personal remarks:</label>
                {{form.personal_remarks|add_class:"form-control"|attr:"rows:3"}}

                <label for="{{form.customer_remarks.label}}" class="form-label">Customer remarks:</label>
                {{form.customer_remarks|add_class:"form-control"|attr:"rows:3"}}

            </div>
            
            <button type="submit" class="btn-primary btn my-3 w-100">Transact</button>
        </form>
        
        

    </div>

</main>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // live_datetime.js
    function updateLiveDateTime() {
        const datetimeElement = document.getElementById('live-datetime');
        const now = new Date();
        const formattedDateTime = now.toLocaleString(); // Adjust formatting as needed
        datetimeElement.textContent = formattedDateTime;
    }

    // Update every second
    setInterval(updateLiveDateTime, 1000);


    $(document).ready(function() {
        function testing(){
            const grandTotalField = document.getElementById('id_grand_total').value = "22";
        }
        // Add SaleService Form
        $('#add-service-btn').click(function() {
            const serviceForms = $('.service-form');
            const totalServiceForms = serviceForms.length;
            const emptyServiceFormTemplate = $(serviceForms[0]).prop('outerHTML');
            const newServiceForm = emptyServiceFormTemplate.replace(/__prefix__/g, totalServiceForms);
            $('#services-container').append(newServiceForm);

            // Update TOTAL_FORMS for SaleServices
            $("input[name='saleservices_set-TOTAL_FORMS']").val(totalServiceForms + 1);
        });

        // Add ServiceImage Form
        $('#services-container').on('click', '.add-image-btn', function() {
            const parentServiceForm = $(this).closest('.service-form');
            const imageForms = parentServiceForm.find('.image-form');
            const totalImageForms = imageForms.length;
            const emptyImageFormTemplate = $(imageForms[0]).prop('outerHTML');
            const newImageForm = emptyImageFormTemplate.replace(/__prefix__/g, totalImageForms);
            parentServiceForm.find('.images-container').append(newImageForm);

            // Update TOTAL_FORMS for ServiceImages
            parentServiceForm.find("input[name='serviceimages_set-TOTAL_FORMS']").val(totalImageForms + 1);
        });

        // Remove SaleService Form
        $('#services-container').on('click', '.remove-service-btn', function() {
            $(this).closest('.service-form').remove();
        });

        // Remove ServiceImage Form
        $('#services-container').on('click', '.remove-image-btn', function() {
            $(this).closest('.image-form').remove();
        });

        // Initial setup
        toggleFields();

        // When payment type changes
        $('#id_payment_type').change(function() {
            toggleFields();
        });

        function toggleFields() {
            var paymentType = $('#id_payment_type').val();

            // Enable or disable package history based on payment type
            if (paymentType === 'package') {
                $('#id_package_history').prop('disabled', false);
            } else {
                $('#id_package_history').prop('disabled', true);
            }

            // Enable or disable credit history based on payment type
            if (paymentType === 'instorecredit') {
                $('#id_credit_history').prop('disabled', false);
            } else {
                $('#id_credit_history').prop('disabled', true);
            }
        }


    });

    function calculate_total(){
        const servicePriceFields = document.querySelectorAll('.service-price');
        const grandTotalField = document.getElementById('id_grand_total');
        console.log(servicePriceFields);
            let total = 0;
            servicePriceFields.forEach(field => {
                if (!field.disabled) {
                    const value = parseFloat(field.value);
                    if (!isNaN(value)) {
                        total += value;
                    }
                }
        });

        // Update the grand total field
        grandTotalField.value = total.toFixed(2);
    }

    
</script>
{% endblock %}